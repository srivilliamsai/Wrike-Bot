
try 
{
	query = Map();
	query.put("criteria","userid=" + user.get("id"));
	db = zoho.cliq.getRecords("wrikedb",query);
	if(db.get("status") == "SUCCESS")
	{
		if(db.get("list").size() == 0)
		{
			response = invokeurl
			[
				url :"https://www.wrike.com/api/v4/contacts?me=true"
				type :GET
				connection:"wrikeconnection"
			];
			info response;
			contacts = response.get("data");
			if(contacts == null)
			{
				contacts = list();
			}
			info contacts;
			account_id = "";
			account_name = "";
			for each  contact in contacts
			{
				profiles = contact.get("profiles");
				if(profiles == null)
				{
					profiles = list();
				}
				for each  profile in profiles
				{
					if(profile.get("accountId") != null && profile.get("accountId") != "")
					{
						account_id = profile.get("accountId");
						break;
					}
				}
				if(account_name == "" && contact.get("companyName") != null)
				{
					account_name = contact.get("companyName");
				}
				if(account_id != "" && account_name != "")
				{
					break;
				}
			}
			if(account_name == "" && contacts.size() > 0)
			{
				default_contact = contacts.get(0);
				full_name = (ifnull(default_contact.get("firstName"),"") + " " + ifnull(default_contact.get("lastName"),"")).trim();
				if(full_name != "")
				{
					account_name = full_name;
				}
			}
			if(account_name == "")
			{
				account_name = "Wrike Workspace";
			}
			if(account_id == "" || account_name == "")
			{
				response = Map();
				bot = Map();
				bot.put("name","Wrike Bot");
				bot.put("image","https://i.postimg.cc/Wzq58K7J/wrikelogo.png");
				response.put("bot",bot);
				buttonsList = list();
				buttonsList0 = Map();
				buttonsList0.put("label","Create Account");
				buttonsList0.put("type","+");
				action = Map();
				action.put("type","open.url");
				data = Map();
				data.put("web","https://www.wrike.com/");
				action.put("data",data);
				buttonsList0.put("action",action);
				buttonsList.add(buttonsList0);
				response.put("buttons",buttonsList);
				response.put("text","Hey " + user.get("first_name") + " ! You don't have any Wrike account associated with your profile.");
				return response;
			}
			else
			{
				values = Map();
				values.put("userid",user.get("id"));
				values.put("accountid",account_id);
				values.put("accountname",account_name);
				values.put("projectid","0");
				values.put("todolistid","0");
				db = zoho.cliq.createRecord("wrikedb",values);
				info db;
			}
		}
	}
	else
	{
		response = Map();
		bot = Map();
		bot.put("name","Wrike Bot");
		bot.put("image","https://i.postimg.cc/Wzq58K7J/wrikelogo.png");
		response.put("bot",bot);
		card = Map();
		card.put("theme","modern-inline");
		response.put("card",card);
		response.put("text","âš ï¸ Oops! Something went wrong. ğŸ˜” Please try again later");
		return response;
	}
	query = Map();
	query.put("criteria","userid=" + user.get("id"));
	db = zoho.cliq.getRecords("wrikedb",query);
	if(sub_action.containsIgnoreCase("Un Map Channel"))
	{
		query = Map();
		query.put("criteria","userid=" + user.get("id"));
		db = zoho.cliq.getRecords("wrikechannelmapping");
		response = Map();
		bot = Map();
		bot.put("name","Wrike Bot");
		bot.put("image","https://i.postimg.cc/Wzq58K7J/wrikelogo.png");
		response.put("bot",bot);
		response.put("text","Hello [" + user.get("first_name") + "](zohoid:" + user.get("zoho_user_id") + ") ğŸ‘‹ \nDetails of your mapped projects");
		card = Map();
		card.put("title","Mapped Channels");
		card.put("theme","modern-inline");
		response.put("card",card);
		slidesList = list();
		info db.get("list");
		for each  row in db.get("list")
		{
			slidesList0 = Map();
			slidesList0.put("type","label");
			slidesList0.put("title",row.get("projectname"));
			buttonsList = list();
			buttonsList0 = Map();
			buttonsList0.put("label","Un Map");
			buttonsList0.put("type","-");
			action = Map();
			action.put("type","invoke.function");
			data = Map();
			data.put("name","unmapchannel");
			action.put("data",data);
			buttonsList0.put("action",action);
			buttonsList0.put("key",row.get("projectid") + "|" + row.get("webhookid") + "|" + row.get("channeluniquename"));
			buttonsList.add(buttonsList0);
			slidesList0.put("buttons",buttonsList);
			dataList = list();
			dataList0 = Map();
			dataList0.put("Channel Name",row.get("channeluniquename"));
			dataList.add(dataList0);
			dataList1 = Map();
			event_format = "";
			for each  event in row.get("events")
			{
				event_format = event_format + " " + event + ",";
			}
			dataList1.put("Events",event_format.subString(0,event_format.length() - 1));
			dataList.add(dataList1);
			slidesList0.put("data",dataList);
			slidesList.add(slidesList0);
		}
		if(slidesList.size() != 0)
		{
			response.put("slides",slidesList);
		}
		else
		{
			slidesList = list();
			slidesList0 = Map();
			slidesList0.put("type","text");
			slidesList0.put("data","No channels have been mapped yet. Start mapping your channels to stay informed and boost productivity! ğŸš€");
			slidesList.add(slidesList0);
			response.put("slides",slidesList);
		}
		return response;
	}
	if(sub_action.containsIgnoreCase("Map Channel"))
	{
		content = "Hello [" + user.get("first_name") + "](zohoid:" + user.get("zoho_user_id") + ") ğŸ‘‹\n\nğŸ“¢ Set Up Notifications in Zoho Cliq!\n\nMap your channel to get instant notifications for all your important events. Stay informed, stay productive, and never miss a beat! ğŸš€\n\nStay notified and stay productive! ğŸ’¼ğŸ””\n\nLet's get started! Simply click the link below to set up your notifications.";
		query_zapikey = Map();
		query_zapikey.put("criteria","userid=" + user.get("id"));
		db_query_zapikey = zoho.cliq.getRecords("wrikezapikey",query_zapikey);
		if(db_query_zapikey.get("list").size() == 0)
		{
			response = Map();
			response = {"text":content,"buttons":{{"label":"Map Channel","type":"+","action":{"type":"invoke.function","data":{"name":"mapchannelform"},"confirm":{"title":"Connect to Wrike Projects from within Cliq","description":"","input":{"type":"user_webhook_token"}}}}}};
			return response;
		}
		else
		{
			response = Map();
			response = {"text":content,"buttons":{{"label":"Map Channel","type":"+","action":{"type":"invoke.function","data":{"name":"mapchannelform"}},"key":"generated"}}};
			return response;
		}
	}
	return Map();
}
catch (e)
{
	info e;
	response = Map();
	bot = Map();
	bot.put("name","Wrike Bot");
	bot.put("image","https://i.postimg.cc/Wzq58K7J/wrikelogo.png");
	response.put("bot",bot);
	card = Map();
	card.put("title","Oops! You've Hit the Fun Limit! ğŸ¢");
	card.put("theme","modern-inline");
	response.put("card",card);
	response.put("text","Looks like you've reached the maximum number of calls for now. Take a break, grab a coffee â˜•, and come back later for more fun and productivity! ğŸš€");
	return response;
}
return Map();
